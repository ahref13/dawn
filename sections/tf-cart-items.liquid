{% comment %} THE FALL â€“ Cart Items {% endcomment %}

<section class="w-full min-h-screen pb-16 px-5 md:px-[30px] lg:px-[50px]" style="margin-top: 130px;" >
    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 xl:grid-cols-8 gap-[15px] md:gap-5 lg:gap-10">

        <!-- Heading spans full width -->
        <div class="col-span-2 md:col-span-4 lg:col-span-6 xl:col-span-8 mb-8">
            <h1 class="font-sm uppercase font-normal">CART</h1>
        </div>

        {% if cart.item_count > 0 %}
            <!-- Cart Items - Takes up most columns -->
            <div class="col-span-2 md:col-span-4 lg:col-span-4 xl:col-span-5">
                <form action="{{ routes.cart_url }}" method="post" novalidate id="cart">
                    <!-- Desktop Table Header (hidden on mobile) -->
                    <div class="hidden lg:grid grid-cols-12 gap-4 pb-4 border-b border-black mb-4">
                        <div class="col-span-5 font-sm">Product</div>
                        <div class="col-span-2 font-sm">Price</div>
                        <div class="col-span-3 font-sm">Quantity</div>
                        <div class="col-span-2 font-sm text-right">Total</div>
                    </div>

                    <!-- Mobile Table Header (visible only on mobile) -->
                    <div class="grid lg:hidden grid-cols-3 gap-4 pb-4 border-b border-black mb-6">
                        <div class="font-sm">Product</div>
                        <div class="font-sm">Information</div>
                        <div class="font-sm text-right">Total</div>
                    </div>

                    <!-- Cart Items List -->
                    <div class="space-y-6">
                        {%- for item in cart.items -%}
                            <!-- Desktop Layout -->
                            <div class="hidden lg:grid grid-cols-12 gap-4 pb-6 border-b border-black items-center"
                                 data-line="{{ forloop.index }}"
                                 id="CartItem-{{ item.index | plus: 1 }}">

                                <!-- Product (Image + Details) -->
                                <div class="col-span-5 flex gap-4">
                                    {% if item.image %}
                                        <a href="{{ item.url }}" class="flex-shrink-0">
                                            <img src="{{ item.image | image_url: width: 200 }}"
                                                 alt="{{ item.title | escape }}"
                                                 class="h-auto object-cover"
                                                 loading="lazy">
                                        </a>
                                    {% endif %}
                                    <div class="flex flex-col justify-center">
                                        <a href="{{ item.url }}" class="no-underline">
                                            <h3 class="font-xs font-normal mb-2">
                                                {{ item.product.title | escape }}
                                            </h3>
                                        </a>
                                        {%- if item.product.has_only_default_variant == false -%}
                                            {%- for option in item.options_with_values -%}
                                                <p class="font-xs text-gray-600">
                                                    {{ option.name }}: {{ option.value }}
                                                </p>
                                            {%- endfor -%}
                                        {%- endif -%}
                                    </div>
                                </div>

                                <!-- Price -->
                                <div class="col-span-2">
                                    {%- if item.original_price != item.final_price -%}
                                        <span class="line-through text-gray-500 font-xs mr-2">
                                            {{ item.original_price | money }}
                                        </span>
                                    {%- endif -%}
                                    <span class="font-xs">{{ item.final_price | money }}</span>
                                </div>

                                <!-- Quantity Controls -->
                                <div class="col-span-3">
                                    <div class="flex items-center gap-3 mb-2 -ml-[10px]">
                                        <div class="flex items-center">
                                            <button class="w-8 h-8 flex items-center justify-center border-none bg-transparent cursor-pointer font-xs hover:opacity-60 transition-opacity"
                                                    type="button"
                                                    data-action="decrease"
                                                    data-line="{{ forloop.index }}"
                                                    aria-label="Decrease quantity">
                                                -
                                            </button>
                                            <input class="w-12 h-8 text-center border-0 border-b border-black font-xs mx-2 [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none"
                                                   type="number"
                                                   name="updates[]"
                                                   value="{{ item.quantity }}"
                                                   min="0"
                                                   data-line="{{ forloop.index }}"
                                                   data-index="{{ item.index | plus: 1 }}"
                                                   id="Quantity-{{ item.index | plus: 1 }}"
                                                   aria-label="Quantity">
                                            <button class="w-8 h-8 flex items-center justify-center border-none bg-transparent cursor-pointer font-xs hover:opacity-60 transition-opacity"
                                                    type="button"
                                                    data-action="increase"
                                                    data-line="{{ forloop.index }}"
                                                    aria-label="Increase quantity">
                                                +
                                            </button>
                                            <button type="button"
                                                    class="font-xs underline bg-transparent border-none cursor-pointer p-0 hover:opacity-60 transition-opacity"
                                                    data-line="{{ forloop.index }}"
                                                    aria-label="Remove item">
                                                Remove
                                            </button>
                                        </div>
                                    </div>


                                    <!-- Error Message -->
                                    <div class="mt-2 opacity-0 max-h-0 overflow-hidden transition-all duration-300"
                                         id="Line-item-error-{{ item.index | plus: 1 }}"
                                         role="alert">
                                        <small class="font-xs text-red-600 block"></small>
                                    </div>
                                </div>

                                <!-- Line Total -->
                                <div class="col-span-2 text-right">
                                    {%- if item.original_line_price != item.final_line_price -%}
                                        <span class="line-through text-gray-500 font-xs mr-2">
                                            {{ item.original_line_price | money }}
                                        </span>
                                    {%- endif -%}
                                    <span class="font-xs font-medium">{{ item.final_line_price | money }}</span>
                                </div>
                            </div>

                            <!-- Mobile Layout (3 columns like screenshot) -->
                            <div class="grid lg:hidden grid-cols-3 gap-4 pb-6 border-b border-black items-start"
                                 data-line="{{ forloop.index }}"
                                 id="CartItem-mobile-{{ item.index | plus: 1 }}">

                                <!-- Column 1: Product Image -->
                                <div>
                                    {% if item.image %}
                                        <a href="{{ item.url }}">
                                            <img src="{{ item.image | image_url: width: 300 }}"
                                                 alt="{{ item.title | escape }}"
                                                 class="w-full h-auto object-cover"
                                                 loading="lazy">
                                        </a>
                                    {% endif %}
                                </div>

                                <!-- Column 2: Information (Title, Variant, Price, Quantity) -->
                                <div class="flex flex-col justify-between h-full">
                                    <div>
                                        <a href="{{ item.url }}" class="no-underline">
                                            <h3 class="font-xs font-normal mb-1">
                                                {{ item.product.title | escape }}
                                            </h3>
                                        </a>
                                        {%- if item.product.has_only_default_variant == false -%}
                                            {%- for option in item.options_with_values -%}
                                                <p class="font-xs text-gray-600">
                                                    {{ option.value }}
                                                </p>
                                            {%- endfor -%}
                                        {%- endif -%}
                                    </div>

                                    <div class="font-xs">
                                        {%- if item.original_price != item.final_price -%}
                                            <span class="line-through text-gray-500 mr-2">
                    {{ item.original_price | money }}
                </span>
                                        {%- endif -%}
                                        <span>{{ item.final_price | money }}</span>
                                    </div>

                                    <div class="flex items-center gap-3">
                                        <div class="flex items-center border-b border-black">
                                            <button class="w-8 h-8 flex items-center justify-center border-none bg-transparent cursor-pointer font-xs hover:opacity-60 transition-opacity"
                                                    type="button"
                                                    data-action="decrease"
                                                    data-line="{{ forloop.index }}"
                                                    aria-label="Decrease quantity">
                                                -
                                            </button>
                                            <input class="w-12 h-8 text-center border-0 font-xs mx-2 [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none"
                                                   type="number"
                                                   name="updates[]"
                                                   value="{{ item.quantity }}"
                                                   min="0"
                                                   data-line="{{ forloop.index }}"
                                                   data-index="{{ item.index | plus: 1 }}"
                                                   id="Quantity-mobile-{{ item.index | plus: 1 }}"
                                                   aria-label="Quantity">
                                            <button class="w-8 h-8 flex items-center justify-center border-none bg-transparent cursor-pointer font-xs hover:opacity-60 transition-opacity"
                                                    type="button"
                                                    data-action="increase"
                                                    data-line="{{ forloop.index }}"
                                                    aria-label="Increase quantity">
                                                +
                                            </button>
                                        </div>
                                        <button type="button"
                                                class="font-xs underline bg-transparent border-none cursor-pointer p-0 hover:opacity-60 transition-opacity"
                                                data-line="{{ forloop.index }}"
                                                aria-label="Remove item">
                                            Remove
                                        </button>
                                    </div>

                                    <!-- Error Message -->
                                    <div class="opacity-0 max-h-0 overflow-hidden transition-all duration-300"
                                         id="Line-item-error-mobile-{{ item.index | plus: 1 }}"
                                         role="alert">
                                        <small class="font-xs text-red-600 block"></small>
                                    </div>
                                </div>

                                <!-- Column 3: Total -->
                                <div class="text-right font-xs">
                                    {%- if item.original_line_price != item.final_line_price -%}
                                        <span class="line-through text-gray-500 block mb-1">
                {{ item.original_line_price | money }}
            </span>
                                    {%- endif -%}
                                    <span class="font-medium">{{ item.final_line_price | money }}</span>
                                </div>
                            </div>
                        {%- endfor -%}
                    </div>
                </form>
            </div>

            <!-- Sidebar - Subtotal & Checkout (outside form, now sticky works!) -->
            <div class="col-span-2 md:col-span-4 lg:col-span-2 xl:col-span-3">
                <div class="lg:sticky lg:top-[130px]">
                    <div class="flex flex-col gap-8">
                        <div class="flex justify-between items-center pb-4 border-b border-black">
                            <span class="font-sm font-medium uppercase">Subtotal</span>
                            <span class="font-sm font-medium">{{ cart.total_price | money }}</span>
                        </div>
                        <button type="submit"
                                form="cart"
                                name="checkout"
                                class="w-full py-5 px-8 font-xs font-normal uppercase bg-black text-white border-none cursor-pointer hover:bg-gray-800 transition-colors">
                            Checkout
                        </button>
                    </div>
                </div>
            </div>

        {% else %}
            <!-- Empty Cart -->
            <div class="col-span-2 md:col-span-4 lg:col-span-6 xl:col-span-8 text-center py-16">
                <p class="font-sm mb-8">Your cart is empty.</p>
                <a href="/collections/all"
                   class="inline-block py-4 px-8 font-xs font-normal uppercase bg-black text-white no-underline hover:bg-gray-800 transition-colors">
                    Continue Shopping
                </a>
            </div>
        {% endif %}

    </div>
</section>

<script>
  (function() {
    // Quantity buttons
    document.querySelectorAll('[data-action]').forEach(btn => {
      btn.addEventListener('click', function() {
        const line = this.dataset.line;
        const input = document.querySelector(`input[data-line="${line}"]`);
        const previousQty = parseInt(input.value);
        let qty = previousQty;

        if (this.dataset.action === 'increase') {
          qty++;
        } else if (this.dataset.action === 'decrease' && qty > 1) {
          qty--;
        }

        input.value = qty;
        updateCart(line, qty, previousQty, input);
      });
    });

    // Quantity input change
    document.querySelectorAll('input[type="number"][data-line]').forEach(input => {
      let previousValue = input.value;

      input.addEventListener('focus', function() {
        previousValue = this.value;
      });

      input.addEventListener('change', function() {
        const line = this.dataset.line;
        let qty = parseInt(this.value);

        if (isNaN(qty) || qty < 0) qty = 0;
        this.value = qty;

        updateCart(line, qty, previousValue, this);
      });
    });

    // Remove buttons
    document.querySelectorAll('button[type="button"]:not([data-action])').forEach(btn => {
      if (btn.textContent.trim() === 'Remove') {
        btn.addEventListener('click', function() {
          const line = this.dataset.line;
          const input = document.querySelector(`input[data-line="${line}"]`);
          const previousQty = parseInt(input.value);
          updateCart(line, 0, previousQty, input);
        });
      }
    });


    function updateCart(line, quantity, previousQty, inputElement) {
      const dataIndex = inputElement.dataset.index;
      const errorContainer = document.querySelector(`#Line-item-error-${dataIndex}`) ||
        document.querySelector(`#Line-item-error-mobile-${dataIndex}`);
      const errorText = errorContainer?.querySelector('small');

      // Clear previous errors
      if (errorContainer) {
        errorContainer.classList.remove('opacity-100', 'max-h-24');
        errorContainer.classList.add('opacity-0', 'max-h-0');
        if (errorText) errorText.textContent = '';
      }

      fetch('/cart/change.js', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ line: line, quantity: quantity })
      })
        .then(res => {
          if (!res.ok) {
            return res.json().then(err => { throw err; });
          }
          return res.json();
        })
        .then(() => window.location.reload())
        .catch(err => {
          console.error('Cart update error:', err);

          // Revert to previous quantity on error
          if (inputElement) {
            inputElement.value = previousQty;
          }

          // Show error message
          if (errorContainer && errorText) {
            errorText.textContent = err.message || err.description || 'Unable to update cart';
            errorContainer.classList.remove('opacity-0', 'max-h-0');
            errorContainer.classList.add('opacity-100', 'max-h-24');
          }
        });
    }
  })();
</script>

{% schema %}
{
  "name": "TF â€¢ Cart items",
  "settings": [],
  "presets": [
    {
      "name": "TF â€¢ Cart items"
    }
  ]
}
{% endschema %}